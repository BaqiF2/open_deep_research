# Open Deep Research ä»£ç æ¶æ„è¯¦è§£

## ğŸ“š ç›®å½•ç»“æ„

```
src/open_deep_research/
â”œâ”€â”€ configuration.py    # é…ç½®ç®¡ç†æ¨¡å—
â”œâ”€â”€ deep_researcher.py # æ ¸å¿ƒç ”ç©¶æµç¨‹å®ç°
â”œâ”€â”€ prompts.py         # æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ state.py           # çŠ¶æ€å®šä¹‰
â””â”€â”€ utils.py           # å·¥å…·å‡½æ•°
```

---

## 1. configuration.py - é…ç½®ç®¡ç†è¯¦è§£

### 1.1 æ¨¡å—èŒè´£

è´Ÿè´£ç®¡ç†æ•´ä¸ªç³»ç»Ÿçš„é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬ï¼š
- æœç´¢ API é€‰æ‹©
- æ¨¡å‹é…ç½®ï¼ˆç ”ç©¶ã€æ‘˜è¦ã€å‹ç¼©ã€æŠ¥å‘Šç”Ÿæˆï¼‰
- ç ”ç©¶å‚æ•°ï¼ˆè¿­ä»£æ¬¡æ•°ã€å¹¶å‘æ•°ç­‰ï¼‰
- MCP æœåŠ¡å™¨é…ç½®

### 1.2 æ ¸å¿ƒç±»è¯¦è§£

#### SearchAPI æšä¸¾

```python
class SearchAPI(Enum):
    ANTHROPIC = "anthropic"  # Anthropic åŸç”Ÿç½‘ç»œæœç´¢
    OPENAI = "openai"       # OpenAI åŸç”Ÿç½‘ç»œæœç´¢
    TAVILY = "tavily"       # Tavily æœç´¢ APIï¼ˆé»˜è®¤ï¼‰
    NONE = "none"           # ä¸ä½¿ç”¨æœç´¢
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- `TAVILY`ï¼šé»˜è®¤é€‰æ‹©ï¼Œæä¾›å…¨é¢çš„ç½‘ç»œæœç´¢èƒ½åŠ›
- `OPENAI`ï¼šä½¿ç”¨ OpenAI æ¨¡å‹çš„åŸç”Ÿæœç´¢åŠŸèƒ½
- `ANTHROPIC`ï¼šä½¿ç”¨ Anthropic æ¨¡å‹çš„åŸç”Ÿæœç´¢åŠŸèƒ½
- `NONE`ï¼šä»…ä½¿ç”¨ MCP å·¥å…·è¿›è¡Œç ”ç©¶

#### Configuration ç±»

**å…³é”®é…ç½®é¡¹åˆ†ç±»**ï¼š

1. **é€šç”¨é…ç½®**
   - `max_structured_output_retries`ï¼šç»“æ„åŒ–è¾“å‡ºå¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°
   - `allow_clarification`ï¼šæ˜¯å¦å…è®¸å‘ç”¨æˆ·æ¾„æ¸…é—®é¢˜
   - `max_concurrent_research_units`ï¼šæœ€å¤§å¹¶å‘ç ”ç©¶å•å…ƒæ•°ï¼ˆå½±å“å¹¶è¡Œåº¦ï¼‰

2. **ç ”ç©¶é…ç½®**
   - `search_api`ï¼šæœç´¢ API æä¾›å•†é€‰æ‹©
   - `max_researcher_iterations`ï¼šç ”ç©¶ç›‘ç£è€…æœ€å¤§è¿­ä»£æ¬¡æ•°
   - `max_react_tool_calls`ï¼šå•ä¸ªç ”ç©¶æ­¥éª¤æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°

3. **æ¨¡å‹é…ç½®**
   - æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‹¬ç«‹çš„æ¨¡å‹é…ç½®ï¼š
     - `summarization_model`ï¼šæ‘˜è¦æ¨¡å‹ï¼ˆå¤„ç†æœç´¢ç»“æœï¼‰
     - `research_model`ï¼šç ”ç©¶æ¨¡å‹ï¼ˆæ‰§è¡Œç ”ç©¶ä»»åŠ¡ï¼‰
     - `compression_model`ï¼šå‹ç¼©æ¨¡å‹ï¼ˆæ•´åˆç ”ç©¶å‘ç°ï¼‰
     - `final_report_model`ï¼šæŠ¥å‘Šæ¨¡å‹ï¼ˆç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼‰
   - æ¯ä¸ªæ¨¡å‹éƒ½æœ‰å¯¹åº”çš„ `max_tokens` é…ç½®

4. **MCP é…ç½®**
   - `mcp_config`ï¼šMCP æœåŠ¡å™¨é…ç½®ï¼ˆURLã€å·¥å…·åˆ—è¡¨ã€è®¤è¯è¦æ±‚ï¼‰
   - `mcp_prompt`ï¼šMCP å·¥å…·çš„é¢å¤–è¯´æ˜

**é…ç½®åŠ è½½æœºåˆ¶**ï¼š

```python
@classmethod
def from_runnable_config(cls, config: Optional[RunnableConfig] = None) -> "Configuration":
    """ä» LangGraph çš„ RunnableConfig åˆ›å»ºé…ç½®å®ä¾‹"""
    # ä¼˜å…ˆçº§ï¼šç¯å¢ƒå˜é‡ > config ä¸­çš„ configurable > é»˜è®¤å€¼
```

---

## 2. deep_researcher.py - æ ¸å¿ƒæµç¨‹è¯¦è§£

### 2.1 ä¸»å·¥ä½œæµæ¶æ„

ç³»ç»Ÿä½¿ç”¨ LangGraph æ„å»ºäº†ä¸€ä¸ªå¤šé˜¶æ®µçš„çŠ¶æ€å›¾ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    START    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ clarify_with_user   â”‚ â—„â”€â”€â”€ å¯é€‰ï¼šå‘ç”¨æˆ·æ¾„æ¸…é—®é¢˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ write_research_briefâ”‚ â—„â”€â”€â”€ ç”Ÿæˆç ”ç©¶ç®€æŠ¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ research_supervisor â”‚ â—„â”€â”€â”€ ç ”ç©¶ç›‘ç£è€…å­å›¾ï¼ˆå¹¶è¡Œç ”ç©¶ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚final_report_generationâ”‚ â—„â”€â”€â”€ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     END     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 èŠ‚ç‚¹åŠŸèƒ½è¯¦è§£

#### clarify_with_user èŠ‚ç‚¹

**åŠŸèƒ½**ï¼šåˆ†æç”¨æˆ·è¾“å…¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ¾„æ¸…é—®é¢˜

**å®ç°é€»è¾‘**ï¼š
1. æ£€æŸ¥ `allow_clarification` é…ç½®
2. å¦‚æœç¦ç”¨æ¾„æ¸…ï¼Œç›´æ¥è¿›å…¥ç ”ç©¶é˜¶æ®µ
3. å¦‚æœå¯ç”¨ï¼Œä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºåˆ†æç”¨æˆ·æ¶ˆæ¯
4. æ ¹æ®åˆ†æç»“æœå†³å®šï¼š
   - éœ€è¦æ¾„æ¸… â†’ è¿”å›é—®é¢˜ç»™ç”¨æˆ·
   - ä¸éœ€è¦æ¾„æ¸… â†’ è¿›å…¥ç ”ç©¶é˜¶æ®µ

**ä½¿ç”¨çš„ç»“æ„åŒ–è¾“å‡º**ï¼š`ClarifyWithUser`

**å…³é”®ä»£ç é€»è¾‘**ï¼š
```python
if response.need_clarification:
    return Command(goto=END, update={"messages": [AIMessage(content=response.question)]})
else:
    return Command(goto="write_research_brief", update={"messages": [AIMessage(content=response.verification)]})
```

#### write_research_brief èŠ‚ç‚¹

**åŠŸèƒ½**ï¼šå°†ç”¨æˆ·æ¶ˆæ¯è½¬æ¢ä¸ºç»“æ„åŒ–çš„ç ”ç©¶ç®€æŠ¥

**å®ç°é€»è¾‘**ï¼š
1. ä½¿ç”¨ç ”ç©¶æ¨¡å‹åˆ†æç”¨æˆ·æ¶ˆæ¯
2. ç”Ÿæˆè¯¦ç»†çš„ç ”ç©¶ç®€æŠ¥ï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·åå¥½å’Œç»†èŠ‚ï¼‰
3. åˆå§‹åŒ–ç ”ç©¶ç›‘ç£è€…çš„ç³»ç»Ÿæç¤ºè¯
4. è®¾ç½®ç›‘ç£è€…çš„åˆå§‹æ¶ˆæ¯

**ä½¿ç”¨çš„ç»“æ„åŒ–è¾“å‡º**ï¼š`ResearchQuestion`

**å…³é”®ä»£ç é€»è¾‘**ï¼š
```python
response = await research_model.ainvoke([HumanMessage(content=prompt_content)])
return Command(
    goto="research_supervisor",
    update={
        "research_brief": response.research_brief,
        "supervisor_messages": {
            "type": "override",
            "value": [SystemMessage(...), HumanMessage(...)]
        }
    }
)
```

#### research_supervisor å­å›¾

**å†…éƒ¨æµç¨‹**ï¼š
```
START â†’ supervisor â†’ supervisor_tools â†’ supervisor â†’ ... â†’ END
```

**supervisor èŠ‚ç‚¹**ï¼š
- åˆ†æç ”ç©¶ç®€æŠ¥å’Œå½“å‰ç ”ç©¶çŠ¶æ€
- ä½¿ç”¨ `think_tool` è¿›è¡Œæˆ˜ç•¥è§„åˆ’
- è°ƒç”¨ `ConductResearch` å§”æ‰˜ç ”ç©¶ä»»åŠ¡
- è°ƒç”¨ `ResearchComplete` æ ‡è®°ç ”ç©¶å®Œæˆ

**supervisor_tools èŠ‚ç‚¹**ï¼š
- å¤„ç† `think_tool` è°ƒç”¨ï¼ˆè®°å½•åæ€ï¼‰
- å¤„ç† `ConductResearch` è°ƒç”¨ï¼ˆå¹¶è¡Œæ‰§è¡Œç ”ç©¶ä»»åŠ¡ï¼‰
- å¤„ç† `ResearchComplete` è°ƒç”¨ï¼ˆç»“æŸç ”ç©¶ï¼‰
- é™åˆ¶å¹¶å‘æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½

**å¹¶è¡Œç ”ç©¶æ‰§è¡Œ**ï¼š
```python
research_tasks = [
    researcher_subgraph.ainvoke({...}, config)
    for tool_call in allowed_conduct_research_calls
]
tool_results = await asyncio.gather(*research_tasks)
```

**é€€å‡ºæ¡ä»¶**ï¼š
- è¶…è¿‡æœ€å¤§è¿­ä»£æ¬¡æ•°
- æ²¡æœ‰å·¥å…·è°ƒç”¨
- è°ƒç”¨äº† `ResearchComplete`

#### researcher å­å›¾

**å†…éƒ¨æµç¨‹**ï¼š
```
START â†’ researcher â†’ researcher_tools â†’ researcher â†’ ... â†’ compress_research â†’ END
```

**researcher èŠ‚ç‚¹**ï¼š
- æ¥æ”¶ç ”ç©¶ä¸»é¢˜
- ä½¿ç”¨å¯ç”¨å·¥å…·ï¼ˆæœç´¢ã€MCP å·¥å…·ç­‰ï¼‰è¿›è¡Œç ”ç©¶
- ä½¿ç”¨ `think_tool` åœ¨æœç´¢ä¹‹é—´è¿›è¡Œåæ€
- å¤šè½®å·¥å…·è°ƒç”¨å¾ªç¯

**researcher_tools èŠ‚ç‚¹**ï¼š
- å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨
- æ£€æµ‹åŸç”Ÿç½‘ç»œæœç´¢è°ƒç”¨
- æ£€æŸ¥è¿­ä»£é™åˆ¶å’Œå®Œæˆæ¡ä»¶
- å†³å®šç»§ç»­ç ”ç©¶æˆ–è¿›å…¥å‹ç¼©é˜¶æ®µ

**å·¥å…·è°ƒç”¨å¾ªç¯**ï¼š
```python
# å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å·¥å…·
tool_execution_tasks = [
    execute_tool_safely(tools_by_name[tool_call["name"]], tool_call["args"], config)
    for tool_call in tool_calls
]
observations = await asyncio.gather(*tool_execution_tasks)
```

**é€€å‡ºæ¡ä»¶**ï¼š
- è¶…è¿‡æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°
- è°ƒç”¨äº† `ResearchComplete`
- æ²¡æœ‰å·¥å…·è°ƒç”¨

#### compress_research èŠ‚ç‚¹

**åŠŸèƒ½**ï¼šå‹ç¼©å’Œæ•´åˆç ”ç©¶å‘ç°

**å®ç°é€»è¾‘**ï¼š
1. æ”¶é›†æ‰€æœ‰ç ”ç©¶æ¶ˆæ¯ï¼ˆå·¥å…·è¾“å‡ºã€AI æ¶ˆæ¯ï¼‰
2. ä½¿ç”¨å‹ç¼©æ¨¡å‹ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦
3. ä¿ç•™æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå»é™¤å†—ä½™
4. åŒ…å«æºå¼•ç”¨å’Œå…³é”®æ‘˜å½•
5. å¤„ç† token é™åˆ¶é”™è¯¯ï¼ˆé‡è¯• + æ¶ˆæ¯æˆªæ–­ï¼‰

**é”™è¯¯å¤„ç†**ï¼š
```python
while synthesis_attempts < max_attempts:
    try:
        response = await synthesizer_model.ainvoke(messages)
        return {"compressed_research": str(response.content), "raw_notes": [...]}
    except Exception as e:
        if is_token_limit_exceeded(e, configurable.research_model):
            researcher_messages = remove_up_to_last_ai_message(researcher_messages)
            continue
```

#### final_report_generation èŠ‚ç‚¹

**åŠŸèƒ½**ï¼šç”Ÿæˆæœ€ç»ˆç ”ç©¶æŠ¥å‘Š

**å®ç°é€»è¾‘**ï¼š
1. æ”¶é›†æ‰€æœ‰ç ”ç©¶å‘ç°å’Œç¬”è®°
2. ä½¿ç”¨æŠ¥å‘Šç”Ÿæˆæ¨¡å‹ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š
3. å¤„ç† token é™åˆ¶é”™è¯¯ï¼ˆæ¸è¿›å¼æˆªæ–­ï¼‰
4. ç¡®ä¿æŠ¥å‘Šè¯­è¨€ä¸ç”¨æˆ·è¾“å…¥ä¸€è‡´

**Token é™åˆ¶å¤„ç†**ï¼š
```python
while current_retry <= max_retries:
    try:
        final_report = await model.ainvoke([HumanMessage(content=prompt)])
        return {"final_report": final_report.content, ...}
    except Exception as e:
        if is_token_limit_exceeded(e, model):
            # æ¸è¿›å¼æˆªæ–­ï¼šæ¯æ¬¡å‡å°‘ 10%
            findings_token_limit = int(findings_token_limit * 0.9)
            findings = findings[:findings_token_limit]
            continue
```

### 2.3 çŠ¶æ€æµè½¬æœºåˆ¶

**çŠ¶æ€æ›´æ–°æ–¹å¼**ï¼š
- ä½¿ç”¨ `Command` å¯¹è±¡æ§åˆ¶æµç¨‹
- `Command.goto` æŒ‡å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- `Command.update` æ›´æ–°çŠ¶æ€

**çŠ¶æ€åˆå¹¶ç­–ç•¥**ï¼š
- æ¶ˆæ¯åˆ—è¡¨ï¼šè¿½åŠ ï¼ˆ`operator.add`ï¼‰
- å…¶ä»–å­—æ®µï¼šè¦†ç›–ï¼ˆ`override_reducer`ï¼‰

---

## 3. prompts.py - æç¤ºè¯è®¾è®¡è¯¦è§£

### 3.1 æç¤ºè¯è®¾è®¡åŸåˆ™

1. **ä»»åŠ¡æ˜ç¡®**ï¼šæ¯ä¸ªæç¤ºè¯éƒ½æœ‰æ¸…æ™°çš„ä»»åŠ¡å®šä¹‰
2. **æ ¼å¼è§„èŒƒ**ï¼šç»Ÿä¸€çš„è¾“å‡ºæ ¼å¼è¦æ±‚
3. **ç¤ºä¾‹å¼•å¯¼**ï¼šæä¾›ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
4. **çº¦æŸæ˜ç¡®**ï¼šæ˜ç¡®é™åˆ¶å’Œè¾¹ç•Œæ¡ä»¶

### 3.2 å…³é”®æç¤ºè¯åˆ†æ

#### lead_researcher_promptï¼ˆç ”ç©¶ç›‘ç£è€…ï¼‰

**æ ¸å¿ƒæŒ‡å¯¼**ï¼š
- ä½¿ç”¨ `think_tool` è¿›è¡Œæˆ˜ç•¥è§„åˆ’
- åˆç†åˆ†è§£ç ”ç©¶ä»»åŠ¡
- æ§åˆ¶ä»»åŠ¡å§”æ‰˜é¢„ç®—
- è¯„ä¼°ç ”ç©¶å®Œæ•´æ€§

**å…³é”®çº¦æŸ**ï¼š
- æœ€å¤§å¹¶å‘ç ”ç©¶å•å…ƒæ•°
- æœ€å¤§è¿­ä»£æ¬¡æ•°
- åå‘ä½¿ç”¨å•ä¸ªæ™ºèƒ½ä½“ï¼ˆé™¤éæœ‰æ˜æ˜¾å¹¶è¡Œæœºä¼šï¼‰

#### research_system_promptï¼ˆç ”ç©¶è€…ï¼‰

**æœç´¢ç­–ç•¥**ï¼š
1. ä»å¹¿æ³›æœç´¢å¼€å§‹
2. é€æ­¥ç¼©å°æœç´¢èŒƒå›´
3. æ¯æ¬¡æœç´¢ååæ€
4. åŠæ—¶åœæ­¢ï¼ˆé¿å…è¿‡åº¦æœç´¢ï¼‰

**å·¥å…·ä½¿ç”¨é¢„ç®—**ï¼š
- ç®€å•æŸ¥è¯¢ï¼š2-3 æ¬¡æœç´¢
- å¤æ‚æŸ¥è¯¢ï¼šæœ€å¤š 5 æ¬¡æœç´¢

**åœæ­¢æ¡ä»¶**ï¼š
- èƒ½å¤Ÿå…¨é¢å›ç­”é—®é¢˜
- æœ‰ 3+ ä¸ªç›¸å…³ç¤ºä¾‹/æº
- æœ€è¿‘ 2 æ¬¡æœç´¢è¿”å›ç›¸ä¼¼ä¿¡æ¯

#### compress_research_system_promptï¼ˆç ”ç©¶å‹ç¼©ï¼‰

**æ ¸å¿ƒè¦æ±‚**ï¼š
- ä¿ç•™æ‰€æœ‰ç›¸å…³ä¿¡æ¯ï¼ˆverbatimï¼‰
- å»é™¤å†—ä½™å’Œæ— å…³ä¿¡æ¯
- åŒ…å«æ‰€æœ‰æºå¼•ç”¨
- ç»“æ„åŒ–è¾“å‡ºæ ¼å¼

**è¾“å‡ºæ ¼å¼**ï¼š
1. æŸ¥è¯¢å’Œå·¥å…·è°ƒç”¨åˆ—è¡¨
2. å…¨é¢ç ”ç©¶å‘ç°
3. æ‰€æœ‰ç›¸å…³æºåˆ—è¡¨ï¼ˆå¸¦å¼•ç”¨ï¼‰

#### final_report_generation_promptï¼ˆæŠ¥å‘Šç”Ÿæˆï¼‰

**æŠ¥å‘Šç»“æ„çµæ´»æ€§**ï¼š
- æ¯”è¾ƒç±»ï¼šæ¦‚è¿° A â†’ æ¦‚è¿° B â†’ æ¯”è¾ƒ â†’ ç»“è®º
- åˆ—è¡¨ç±»ï¼šç›´æ¥åˆ—å‡ºæˆ–åˆ†èŠ‚åˆ—å‡º
- æ¦‚è¿°ç±»ï¼šæ¦‚è¿° â†’ æ¦‚å¿µ 1 â†’ æ¦‚å¿µ 2 â†’ ç»“è®º

**è¯­è¨€ä¸€è‡´æ€§**ï¼š
- å¿…é¡»ä¸ç”¨æˆ·è¾“å…¥è¯­è¨€ä¸€è‡´
- è‡ªåŠ¨æ£€æµ‹å¹¶ç¿»è¯‘

**å¼•ç”¨è§„åˆ™**ï¼š
- æ¯ä¸ª URL åˆ†é…å”¯ä¸€å¼•ç”¨ç¼–å·
- æ–‡å†…å¼•ç”¨ä½¿ç”¨ `[1]` æ ¼å¼
- æ–‡æœ«åˆ—å‡ºæ‰€æœ‰æº

---

## 4. state.py - çŠ¶æ€ç®¡ç†è¯¦è§£

### 4.1 çŠ¶æ€ç±»å‹å±‚æ¬¡

```
MessagesState (LangGraph åŸºç¡€)
    â”œâ”€â”€ AgentInputState (ä»… messages)
    â””â”€â”€ AgentState (å®Œæ•´çŠ¶æ€)
    
TypedDict
    â”œâ”€â”€ SupervisorState (ç›‘ç£è€…çŠ¶æ€)
    â””â”€â”€ ResearcherState (ç ”ç©¶è€…çŠ¶æ€)
    
BaseModel
    â””â”€â”€ ResearcherOutputState (ç ”ç©¶è€…è¾“å‡º)
```

### 4.2 çŠ¶æ€å­—æ®µè¯´æ˜

#### AgentStateï¼ˆä¸»çŠ¶æ€ï¼‰

- `messages`ï¼šç”¨æˆ·å’Œ AI çš„å¯¹è¯æ¶ˆæ¯
- `supervisor_messages`ï¼šç›‘ç£è€…çš„æ¶ˆæ¯å†å²
- `research_brief`ï¼šç ”ç©¶ç®€æŠ¥
- `raw_notes`ï¼šåŸå§‹ç ”ç©¶ç¬”è®°
- `notes`ï¼šå¤„ç†åçš„ç¬”è®°
- `final_report`ï¼šæœ€ç»ˆæŠ¥å‘Š

#### SupervisorStateï¼ˆç›‘ç£è€…çŠ¶æ€ï¼‰

- `supervisor_messages`ï¼šç›‘ç£è€…æ¶ˆæ¯å†å²
- `research_brief`ï¼šç ”ç©¶ç®€æŠ¥
- `notes`ï¼šç¬”è®°åˆ—è¡¨
- `research_iterations`ï¼šå½“å‰è¿­ä»£æ¬¡æ•°
- `raw_notes`ï¼šåŸå§‹ç¬”è®°

#### ResearcherStateï¼ˆç ”ç©¶è€…çŠ¶æ€ï¼‰

- `researcher_messages`ï¼šç ”ç©¶è€…æ¶ˆæ¯å†å²
- `tool_call_iterations`ï¼šå·¥å…·è°ƒç”¨è¿­ä»£æ¬¡æ•°
- `research_topic`ï¼šå½“å‰ç ”ç©¶ä¸»é¢˜
- `compressed_research`ï¼šå‹ç¼©åçš„ç ”ç©¶ç»“æœ
- `raw_notes`ï¼šåŸå§‹ç¬”è®°

### 4.3 çŠ¶æ€æ›´æ–°æœºåˆ¶

**Reducer å‡½æ•°**ï¼š
- `operator.add`ï¼šè¿½åŠ æ“ä½œï¼ˆç”¨äºæ¶ˆæ¯åˆ—è¡¨ï¼‰
- `override_reducer`ï¼šè¦†ç›–æ“ä½œï¼ˆç”¨äºå…¶ä»–å­—æ®µï¼‰

**çŠ¶æ€æ›´æ–°ç¤ºä¾‹**ï¼š
```python
# è¿½åŠ æ¶ˆæ¯
update={"researcher_messages": [new_message]}

# è¦†ç›–å€¼
update={"research_brief": "new brief"}

# ä½¿ç”¨ override ç±»å‹
update={"supervisor_messages": {"type": "override", "value": [new_messages]}}
```

---

## 5. utils.py - å·¥å…·å‡½æ•°è¯¦è§£

### 5.1 æœç´¢å·¥å…·å®ç°

#### tavily_search å‡½æ•°

**å·¥ä½œæµç¨‹**ï¼š
1. å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæœç´¢æŸ¥è¯¢
2. æŒ‰ URL å»é‡ç»“æœ
3. å¹¶è¡Œæ‘˜è¦ç½‘é¡µå†…å®¹ï¼ˆå¦‚æœå†…å®¹è¿‡é•¿ï¼‰
4. æ ¼å¼åŒ–è¾“å‡º

**å…³é”®ä¼˜åŒ–**ï¼š
- å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ
- å†…å®¹é•¿åº¦é™åˆ¶ï¼ˆ`max_content_length`ï¼‰
- è¶…æ—¶ä¿æŠ¤ï¼ˆ60 ç§’ï¼‰
- é”™è¯¯å¤„ç†ï¼ˆè¿”å›åŸå§‹å†…å®¹ï¼‰

#### summarize_webpage å‡½æ•°

**æ‘˜è¦ç­–ç•¥**ï¼š
- ä¿ç•™ä¸»è¦ä¸»é¢˜å’Œç›®çš„
- ä¿ç•™å…³é”®äº‹å®ã€ç»Ÿè®¡æ•°æ®
- ä¿ç•™é‡è¦å¼•ç”¨
- ä¿ç•™æ—¶é—´é¡ºåºï¼ˆå¦‚é€‚ç”¨ï¼‰
- ä¿ç•™åˆ—è¡¨å’Œæ­¥éª¤è¯´æ˜

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "summary": "æ‘˜è¦å†…å®¹",
  "key_excerpts": "æ‘˜å½•1, æ‘˜å½•2, æ‘˜å½•3"
}
```

### 5.2 MCP å·¥å…·é›†æˆ

#### è®¤è¯æµç¨‹

1. **è·å–ä»¤ç‰Œ**ï¼š
   ```
   Supabase Token â†’ OAuth Token Exchange â†’ MCP Access Token
   ```

2. **ä»¤ç‰Œå­˜å‚¨**ï¼š
   - å­˜å‚¨åœ¨ LangGraph çš„é…ç½®å­˜å‚¨ä¸­
   - åŒ…å«è¿‡æœŸæ—¶é—´ä¿¡æ¯
   - è‡ªåŠ¨åˆ·æ–°è¿‡æœŸä»¤ç‰Œ

3. **å·¥å…·åŒ…è£…**ï¼š
   - æ¯ä¸ª MCP å·¥å…·éƒ½åŒ…è£…äº†è®¤è¯å¤„ç†
   - å¤„ç† MCP ç‰¹å®šçš„é”™è¯¯ä»£ç 
   - æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

#### å·¥å…·åŠ è½½æµç¨‹

1. æ£€æŸ¥ MCP é…ç½®
2. å¦‚æœéœ€è¦è®¤è¯ï¼Œè·å–ä»¤ç‰Œ
3. è¿æ¥åˆ° MCP æœåŠ¡å™¨
4. è·å–å¯ç”¨å·¥å…·åˆ—è¡¨
5. è¿‡æ»¤å†²çªçš„å·¥å…·åç§°
6. åªåŠ è½½é…ç½®ä¸­æŒ‡å®šçš„å·¥å…·
7. åŒ…è£…å·¥å…·å¹¶æ·»åŠ åˆ°å·¥å…·åˆ—è¡¨

### 5.3 Token é™åˆ¶å¤„ç†

#### é”™è¯¯æ£€æµ‹

**æ”¯æŒçš„æä¾›å•†**ï¼š
- OpenAIï¼šæ£€æµ‹ `context_length_exceeded` é”™è¯¯
- Anthropicï¼šæ£€æµ‹ `prompt is too long` é”™è¯¯
- Geminiï¼šæ£€æµ‹ `ResourceExhausted` é”™è¯¯

**æ£€æµ‹é€»è¾‘**ï¼š
```python
def is_token_limit_exceeded(exception, model_name):
    # 1. æ ¹æ®æ¨¡å‹åç§°ç¡®å®šæä¾›å•†
    # 2. æ£€æŸ¥æä¾›å•†ç‰¹å®šçš„é”™è¯¯æ¨¡å¼
    # 3. è¿”å› True/False
```

#### é”™è¯¯æ¢å¤ç­–ç•¥

1. **ç ”ç©¶å‹ç¼©é˜¶æ®µ**ï¼š
   - ç§»é™¤åˆ°æœ€åä¸€ä¸ª AI æ¶ˆæ¯
   - é‡è¯•å‹ç¼©ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰

2. **æŠ¥å‘Šç”Ÿæˆé˜¶æ®µ**ï¼š
   - æ¸è¿›å¼æˆªæ–­ç ”ç©¶å‘ç°
   - æ¯æ¬¡é‡è¯•å‡å°‘ 10% å†…å®¹
   - æœ€å¤šé‡è¯• 3 æ¬¡

### 5.4 å·¥å…·ç®¡ç†

#### get_all_tools å‡½æ•°

**å·¥å…·ç»„è£…é¡ºåº**ï¼š
1. æ ¸å¿ƒå·¥å…·ï¼š`ResearchComplete`ã€`think_tool`
2. æœç´¢å·¥å…·ï¼šæ ¹æ®é…ç½®æ·»åŠ 
3. MCP å·¥å…·ï¼šä» MCP æœåŠ¡å™¨åŠ è½½

**å†²çªå¤„ç†**ï¼š
- è·Ÿè¸ªç°æœ‰å·¥å…·åç§°
- è·³è¿‡åç§°å†²çªçš„ MCP å·¥å…·
- å‘å‡ºè­¦å‘Š

---

## ğŸ”§ å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¤šä¸ªæœç´¢æŸ¥è¯¢å¹¶è¡Œæ‰§è¡Œ
- å¤šä¸ªç ”ç©¶å•å…ƒå¹¶è¡Œæ‰§è¡Œ
- å¤šä¸ªå·¥å…·è°ƒç”¨å¹¶è¡Œæ‰§è¡Œ
- å¤šä¸ªç½‘é¡µæ‘˜è¦å¹¶è¡Œæ‰§è¡Œ

**å®ç°æ–¹å¼**ï¼š
```python
tasks = [async_function(arg) for arg in args]
results = await asyncio.gather(*tasks)
```

### 2. é”™è¯¯å¤„ç†å’Œé‡è¯•

**é‡è¯•ç­–ç•¥**ï¼š
- ç»“æ„åŒ–è¾“å‡ºï¼šæœ€å¤šé‡è¯• N æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- Token é™åˆ¶ï¼šæ¸è¿›å¼æˆªæ–­ + é‡è¯•
- è¶…æ—¶ä¿æŠ¤ï¼š60 ç§’è¶…æ—¶ï¼Œè¿”å›åŸå§‹å†…å®¹

**é”™è¯¯åˆ†ç±»**ï¼š
- Token é™åˆ¶é”™è¯¯ï¼šç‰¹æ®Šå¤„ç†ï¼ˆæˆªæ–­ + é‡è¯•ï¼‰
- å…¶ä»–é”™è¯¯ï¼šè®°å½•æ—¥å¿—ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯

### 3. çŠ¶æ€ç®¡ç†

**çŠ¶æ€æ›´æ–°ç­–ç•¥**ï¼š
- æ¶ˆæ¯ï¼šè¿½åŠ ï¼ˆä¿ç•™å†å²ï¼‰
- å…¶ä»–å­—æ®µï¼šè¦†ç›–ï¼ˆæœ€æ–°å€¼ï¼‰

**çŠ¶æ€æµè½¬æ§åˆ¶**ï¼š
- ä½¿ç”¨ `Command` å¯¹è±¡
- `goto` æŒ‡å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- `update` æ›´æ–°çŠ¶æ€

### 4. å·¥å…·è°ƒç”¨å¾ªç¯

**å¾ªç¯æ§åˆ¶**ï¼š
- æœ€å¤§è¿­ä»£æ¬¡æ•°é™åˆ¶
- å®Œæˆæ¡ä»¶æ£€æµ‹
- å·¥å…·è°ƒç”¨ç»“æœåé¦ˆ

**åæ€æœºåˆ¶**ï¼š
- ä½¿ç”¨ `think_tool` åœ¨å…³é”®èŠ‚ç‚¹åæ€
- è¯„ä¼°å½“å‰è¿›åº¦
- å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **å¹¶è¡Œæ‰§è¡Œ**ï¼šæœ€å¤§åŒ–å¹¶å‘åº¦ï¼Œæé«˜æ•ˆç‡
2. **æ™ºèƒ½åœæ­¢**ï¼šé¿å…è¿‡åº¦æœç´¢å’Œè¿­ä»£
3. **å†…å®¹ä¼˜åŒ–**ï¼šæ‘˜è¦é•¿å†…å®¹ï¼Œå‡å°‘ token ä½¿ç”¨
4. **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨å¤„ç† token é™åˆ¶ç­‰é”™è¯¯
5. **èµ„æºç®¡ç†**ï¼šé™åˆ¶å¹¶å‘æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½

---

## ğŸ¯ è®¾è®¡æ¨¡å¼

1. **çŠ¶æ€æœºæ¨¡å¼**ï¼šä½¿ç”¨ LangGraph å®ç°å¤æ‚å·¥ä½œæµ
2. **ç­–ç•¥æ¨¡å¼**ï¼šå¯é…ç½®çš„æœç´¢ API å’Œæ¨¡å‹é€‰æ‹©
3. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼šç»Ÿä¸€çš„æç¤ºè¯æ¨¡æ¿
4. **é€‚é…å™¨æ¨¡å¼**ï¼šMCP å·¥å…·é›†æˆ
5. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šçŠ¶æ€æ›´æ–°å’Œæ¶ˆæ¯ä¼ é€’

---

## ğŸ” ä»£ç è´¨é‡ä¿è¯

1. **ç±»å‹æ³¨è§£**ï¼šå…¨é¢çš„ç±»å‹æç¤º
2. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†
3. **æ—¥å¿—è®°å½•**ï¼šå…³é”®æ“ä½œæ—¥å¿—
4. **æ–‡æ¡£å­—ç¬¦ä¸²**ï¼šè¯¦ç»†çš„å‡½æ•°æ–‡æ¡£
5. **ä»£ç ç»„ç»‡**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£æ¸…æ™°

---

## ğŸ“ æ€»ç»“

Open Deep Research çš„ä»£ç æ¶æ„ä½“ç°äº†ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ï¼ŒèŒè´£æ˜ç¡®
2. **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°å·¥å…·å’ŒåŠŸèƒ½
3. **å¥å£®æ€§**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
4. **é«˜æ•ˆæ€§**ï¼šå¹¶è¡Œæ‰§è¡Œå’Œæ™ºèƒ½ä¼˜åŒ–
5. **å¯é…ç½®**ï¼šé«˜åº¦å¯é…ç½®çš„ç³»ç»Ÿå‚æ•°

é€šè¿‡ LangGraph çš„çŠ¶æ€å›¾ã€å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œã€æ™ºèƒ½è§„åˆ’å’Œé”™è¯¯æ¢å¤ç­‰æœºåˆ¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆã€å¯é åœ°å®Œæˆå¤æ‚çš„æ·±åº¦ç ”ç©¶ä»»åŠ¡ã€‚

