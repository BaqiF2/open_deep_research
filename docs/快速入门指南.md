# Open Deep Research 快速入门指南

## 📖 概述

本指南将帮助您快速理解和使用 Open Deep Research 系统。我们将从基本概念开始，逐步深入到实际使用。

---

## 🎯 核心概念

### 什么是深度研究代理？

深度研究代理是一个能够自动进行多步骤研究的 AI 系统，它能够：
- 理解用户的研究需求
- 自动规划研究策略
- 并行执行多个研究任务
- 整合研究结果
- 生成高质量的研究报告

### 系统架构

```
用户输入
    ↓
澄清问题（可选）
    ↓
生成研究简报
    ↓
研究监督者
    ├─→ 研究者 1（并行）
    ├─→ 研究者 2（并行）
    └─→ 研究者 3（并行）
    ↓
整合研究结果
    ↓
生成最终报告
```

---

## 🏗️ 核心组件

### 1. 研究监督者（Supervisor）

**职责**：
- 分析研究简报
- 规划研究策略
- 分解研究任务
- 协调多个研究者
- 评估研究完整性

**关键工具**：
- `think_tool`：战略反思
- `ConductResearch`：委托研究任务
- `ResearchComplete`：标记研究完成

### 2. 研究者（Researcher）

**职责**：
- 执行具体的研究任务
- 使用搜索工具收集信息
- 使用 MCP 工具访问外部资源
- 反思搜索结果
- 压缩研究结果

**关键工具**：
- `tavily_search`：网络搜索
- `think_tool`：反思搜索结果
- `web_search`：原生网络搜索（OpenAI/Anthropic）
- MCP 工具：自定义工具

### 3. 研究流程

**阶段 1：澄清（可选）**
- 分析用户输入
- 判断是否需要更多信息
- 如果需要，向用户提问

**阶段 2：规划**
- 将用户消息转换为研究简报
- 初始化研究监督者

**阶段 3：执行**
- 监督者规划研究策略
- 并行执行多个研究任务
- 每个研究者独立进行研究

**阶段 4：整合**
- 收集所有研究结果
- 压缩和整理研究发现
- 评估研究完整性

**阶段 5：报告**
- 生成结构化研究报告
- 包含源引用和关键信息

---

## ⚙️ 配置说明

### 基本配置

#### 搜索 API 选择

```python
search_api: SearchAPI = SearchAPI.TAVILY
```

**选项**：
- `TAVILY`：默认，全面的网络搜索
- `OPENAI`：OpenAI 原生搜索
- `ANTHROPIC`：Anthropic 原生搜索
- `NONE`：仅使用 MCP 工具

#### 模型配置

```python
# 摘要模型（处理搜索结果）
summarization_model: str = "openai:gpt-4.1-mini"

# 研究模型（执行研究）
research_model: str = "openai:gpt-4.1"

# 压缩模型（整合研究发现）
compression_model: str = "openai:gpt-4.1"

# 报告模型（生成最终报告）
final_report_model: str = "openai:gpt-4.1"
```

**注意事项**：
- 模型必须支持结构化输出和工具调用
- 每个模型都有对应的 `max_tokens` 配置

#### 研究参数

```python
# 最大并发研究单元数
max_concurrent_research_units: int = 5

# 研究监督者最大迭代次数
max_researcher_iterations: int = 6

# 单个研究步骤最大工具调用次数
max_react_tool_calls: int = 10
```

### 高级配置

#### MCP 工具集成

```python
mcp_config: MCPConfig = MCPConfig(
    url="https://your-mcp-server.com",
    tools=["tool1", "tool2"],
    auth_required=True
)

mcp_prompt: str = "使用这些工具来访问特定的数据源"
```

#### 内容长度限制

```python
# 网页内容最大长度（超过则摘要）
max_content_length: int = 50000
```

---

## 🚀 使用示例

### 示例 1：简单研究查询

**用户输入**：
```
"请研究一下 GPT-5 的主要特性"
```

**系统处理流程**：
1. 澄清阶段：信息充足，跳过
2. 规划阶段：生成研究简报
3. 执行阶段：
   - 监督者规划：研究 GPT-5 的技术特性
   - 研究者执行：搜索相关信息
4. 整合阶段：压缩研究发现
5. 报告阶段：生成最终报告

### 示例 2：比较研究

**用户输入**：
```
"比较 OpenAI 和 Anthropic 在 AI 安全方面的不同方法"
```

**系统处理流程**：
1. 澄清阶段：信息充足，跳过
2. 规划阶段：生成研究简报
3. 执行阶段：
   - 监督者规划：
     - 研究者 1：研究 OpenAI 的 AI 安全方法
     - 研究者 2：研究 Anthropic 的 AI 安全方法
   - 并行执行两个研究任务
4. 整合阶段：整合两个研究结果
5. 报告阶段：生成比较报告

### 示例 3：需要澄清的查询

**用户输入**：
```
"研究一下 AI"
```

**系统处理流程**：
1. 澄清阶段：
   - 检测到信息不足
   - 向用户提问："您想研究 AI 的哪个方面？比如技术发展、应用场景、伦理问题等"
2. 用户回复后，继续研究流程

---

## 🔧 工具使用指南

### 搜索工具

#### Tavily 搜索

```python
# 在研究者中使用
result = await tavily_search(
    queries=["GPT-5 features", "GPT-5 capabilities"],
    max_results=5,
    topic="general"
)
```

**特点**：
- 支持多个查询并行执行
- 自动摘要网页内容
- 返回格式化的搜索结果

#### 原生网络搜索

**OpenAI**：
- 模型自动调用，无需手动配置
- 检测方式：检查 `tool_outputs`

**Anthropic**：
- 模型自动调用，无需手动配置
- 检测方式：检查 `server_tool_use`

### 反思工具

```python
# 在研究过程中使用
reflection = think_tool(
    reflection="我已经找到了 3 个相关源，涵盖了主要特性。"
               "现在应该可以回答用户的问题了。"
)
```

**使用场景**：
- 搜索后反思结果
- 规划下一步行动
- 评估研究完整性

### MCP 工具

**配置步骤**：
1. 配置 MCP 服务器 URL
2. 指定要使用的工具列表
3. 如果需要，配置认证信息
4. 系统自动加载和包装工具

**使用方式**：
- 工具自动添加到研究者工具列表
- 研究者可以像使用其他工具一样使用 MCP 工具

---

## 📊 工作流程详解

### 完整流程示例

假设用户输入："研究一下量子计算的最新进展"

#### 步骤 1：澄清（可选）

```python
# 系统分析
need_clarification = False  # 信息充足
verification = "我将开始研究量子计算的最新进展"
```

#### 步骤 2：生成研究简报

```python
research_brief = """
研究量子计算的最新进展，包括：
- 技术突破
- 主要公司和研究机构
- 实际应用案例
- 未来发展趋势
"""
```

#### 步骤 3：研究监督者规划

```python
# 监督者使用 think_tool 规划
reflection = """
这个研究可以分解为几个方面：
1. 技术突破（最新算法、硬件进展）
2. 主要参与者（公司、研究机构）
3. 应用案例（实际应用）
4. 未来趋势（发展方向）

我可以并行研究这些方面。
"""

# 委托研究任务
ConductResearch(research_topic="研究量子计算的最新技术突破...")
ConductResearch(research_topic="研究量子计算领域的主要公司和研究机构...")
ConductResearch(research_topic="研究量子计算的实际应用案例...")
```

#### 步骤 4：研究者执行

**研究者 1**：
```python
# 搜索
results = await tavily_search(["quantum computing breakthroughs 2024"])

# 反思
think_tool("找到了几个重要的技术突破，包括...")

# 继续搜索
results = await tavily_search(["quantum algorithms recent advances"])

# 压缩结果
compressed_research = "量子计算最新技术突破包括..."
```

**研究者 2 和 3**：类似流程

#### 步骤 5：整合结果

```python
# 监督者收集所有结果
all_findings = [
    researcher_1.compressed_research,
    researcher_2.compressed_research,
    researcher_3.compressed_research
]

# 评估完整性
think_tool("我已经收集了足够的信息，可以生成报告了")

# 标记完成
ResearchComplete()
```

#### 步骤 6：生成报告

```python
final_report = """
# 量子计算的最新进展

## 技术突破
...

## 主要参与者
...

## 应用案例
...

## 未来趋势
...

### 源引用
[1] Source 1: URL
[2] Source 2: URL
...
"""
```

---

## 🎨 最佳实践

### 1. 研究查询优化

**好的查询**：
- 具体明确："研究 GPT-5 在代码生成方面的能力"
- 包含关键信息："比较 OpenAI 和 Anthropic 的 AI 安全方法"
- 明确研究范围："研究 2024 年量子计算的最新进展"

**不好的查询**：
- 过于宽泛："研究 AI"
- 信息不足："研究一下"
- 模糊不清："研究那个东西"

### 2. 配置优化

**性能优化**：
- 根据任务复杂度调整 `max_concurrent_research_units`
- 简单任务：1-2 个并发单元
- 复杂任务：3-5 个并发单元

**成本优化**：
- 使用较小的模型进行摘要（`gpt-4.1-mini`）
- 限制 `max_researcher_iterations` 和 `max_react_tool_calls`
- 设置合理的 `max_content_length`

**质量优化**：
- 使用更强的模型进行研究（`gpt-4.1` 或更高）
- 允许更多的迭代次数
- 启用澄清功能

### 3. 错误处理

**常见错误**：
- Token 限制：系统自动处理，会重试和截断
- API 速率限制：减少并发数
- 搜索无结果：尝试不同的搜索查询

**调试技巧**：
- 查看 LangSmith 日志
- 检查状态更新
- 分析工具调用历史

---

## 🔍 调试和监控

### LangSmith 集成

系统自动集成 LangSmith，可以：
- 查看完整的执行轨迹
- 分析每个节点的输入输出
- 监控工具调用
- 评估性能指标

### 状态检查

**关键状态字段**：
- `research_brief`：研究简报
- `research_iterations`：当前迭代次数
- `tool_call_iterations`：工具调用次数
- `notes`：收集的笔记

### 日志分析

**关键日志点**：
- 澄清决策
- 研究规划
- 工具调用
- 错误处理

---

## 📚 进阶主题

### 1. 自定义提示词

可以修改 `prompts.py` 中的提示词来：
- 调整研究策略
- 改变报告格式
- 添加特定领域的指导

### 2. 添加自定义工具

通过 MCP 集成：
- 连接到自定义数据源
- 添加领域特定的工具
- 扩展研究能力

### 3. 优化研究策略

修改监督者和研究者的提示词：
- 调整搜索策略
- 改变反思频率
- 优化停止条件

---

## ❓ 常见问题

### Q1: 如何提高研究质量？

**A**: 
- 使用更强的研究模型
- 增加迭代次数
- 启用澄清功能
- 使用多个搜索 API

### Q2: 如何降低成本？

**A**:
- 使用较小的摘要模型
- 限制迭代次数
- 减少并发数
- 设置内容长度限制

### Q3: 如何处理 token 限制错误？

**A**: 
- 系统自动处理
- 会重试和截断内容
- 可以调整 `max_content_length`
- 使用更大的模型 token 限制

### Q4: 如何添加新的搜索 API？

**A**:
- 在 `utils.py` 的 `get_search_tool` 中添加
- 实现相应的搜索函数
- 更新 `SearchAPI` 枚举

### Q5: 如何自定义报告格式？

**A**:
- 修改 `final_report_generation_prompt`
- 调整报告结构指导
- 改变引用格式

---

## 📝 总结

Open Deep Research 是一个功能强大的深度研究代理系统。通过理解其核心概念、配置选项和使用方法，您可以：

1. **快速上手**：理解基本概念和工作流程
2. **灵活配置**：根据需求调整系统参数
3. **高效使用**：优化查询和配置
4. **深入定制**：扩展功能和调整策略

希望本指南能帮助您更好地使用 Open Deep Research 系统！

